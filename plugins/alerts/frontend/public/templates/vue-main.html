<script type="text/x-template" id="alerts-home">
    <div id="alerts-view" v-bind:class="[componentId]">
        <cly-header
            :title="i18n('alert.plugin-title')"
            :tooltip="{description: i18n('alert.tips'), placement: 'top-center'}"
        >
            <template v-slot:header-right>
            <el-button type="success" icon="el-icon-circle-plus" v-if="canUserCreate" @click="createAlert">{{i18n('alert.Add_New_Alert')}}</el-button>
        </template>
        </cly-header>
        <cly-main>
            <div class="bu-mb-4 cly-vue-section__content white-bg" v-if="!shouldHideCount" v-loading="!initialized">
                <cly-metric-cards>
                    <cly-metric-card  :columnWidth=4 :color="item.color" :number="item.percent" :key="idx" v-for="(item, idx) in countData">
                            {{i18n(item.label)}}
                        <template v-slot:number>{{item.value || 0}}</template>
                    </cly-metric-card>	
                </cly-metric-cards>	
            </div>
            <div class="bu-mt-6">
                <table-view  v-on:open-drawer="openDrawer" :callCreateAlertDrawer="createAlert"></table-view>
            </div>
        </cly-main>
        <drawer @close="closeDrawer" :controls="drawers.home"></drawer>
    </div>
</script>

<script  type="text/x-template" id="alerts-table">
<div>
    <cly-empty-view 
        v-if="(rowTableRows.length === 0 && initialized)"
        :title="i18n('alerts.empty-title')"
        :subTitle="i18n('alerts.empty-subtitle')"
        :actionTitle="i18n('alerts.empty-action-button-title')"
        :hasAction="canUserCreate"
        :actionFunc="createAlert"
    />
    <cly-section v-else>
        <cly-datatable-n
            :force-loading="!initialized"
            class="cly-vue-alerts-table"
            :tracked-fields="localTableTrackedFields"
            :rows="tableRows"
            :resizable="false">
            <template v-slot:header-left="scope">
                <div class="alerts-table-app-selector">
                    <cly-select-x
                       :placeholder="i18n('alert.all-applications')"
                       mode="multi-check"
                       v-model="filteredApps"
                       :options="appsSelectorOption">
                    </cly-select-x>
                </div>
            </template> 
            <template v-slot="scope">
                <el-table-column type="switch" fixed="left" width="88"  prop="enabled">
                    <template v-slot="rowScope">
                        <el-switch :value="rowScope.row.enabled" :disabled="!rowScope.row._canUpdate"
                            class="bu-ml-4  bu-mr-2"
                            @input="scope.patch(rowScope.row, {enabled: !rowScope.row.enabled})">
                        </el-switch>
                    </template>
                </el-table-column>
               
                <el-table-column fixed min-width="240"  prop="alertName" :label="i18n('alert.Alert_Name')" sortable="true">
                    <template slot-scope="scope">
                        <div style="text-overflow: ellipsis; overflow: hidden;" v-html="scope.row.alertName"></div>
                    </template>
                </el-table-column> 
    
                <el-table-column  min-width="175"  sortable="true"  prop="appNameList" :label="i18n('alert.Application')">
                </el-table-column>
    
                <el-table-column  min-width="415" prop="condtionText"  sortable="true"  :label="i18n('alert.Condition')">
                    <template slot-scope="scope" sortable="true">
                        <span>{{scope.row.condtionText}}</span>
                    </template>
                </el-table-column>
                
                <el-table-column  min-width="130" sortable="true"  prop="createdByUser" :label="i18n('alert.CreateBy')">
                    <template slot-scope="scope">
                        <div class="bu-level">
                            <div class="bu-level-left">
                                <div class="is-created-by-col">
                                    {{scope.row.createdByUser}}
                                 </div>
                            </div> 
                        </div>
                    </template>
                </el-table-column>
              
                
                <el-table-column type="options">
                    <template v-slot="rowScope">
                        <cly-more-options v-if="rowScope.row.hover && (rowScope.row._canUpdate || rowScope.row._canDelete)" size="small" @command="handleAlertEditCommand($event,rowScope)">
                            <el-dropdown-item v-if="rowScope.row._canUpdate" icon="el-icon-document-copy" command="edit-comment">
                                {{i18n('alert.Edit')}}
                            </el-dropdown-item>
                            <el-dropdown-item v-if="rowScope.row._canDelete" icon="el-icon-delete" command="delete-comment">
                                {{i18n('alert.Delete')}}
                            </el-dropdown-item>
                        </cly-more-options>
                    </template>
                </el-table-column>
            </template>
            <template v-slot:bottomline="scope">
                <cly-diff-helper :diff="scope.diff" @discard="scope.unpatch()" @save="updateStatus(scope)">
                </cly-diff-helper>
            </template>
        </cly-datatable-n>
    </cly-section>
</div>
</script>
    
    
    
<script  type="text/x-template" id="alert-drawer">
    <div id="alert-drawer">
        <cly-drawer
            @submit="onSubmit"
            @close="onClose"
            @copy="onCopy"
            :size=6
            :title="title"
            :saveButtonLabel="saveButtonLabel"
            v-bind="$props.controls"  ref="drawerData">>
            <template v-slot:default="drawerScope">
                <cly-form-step id="alert-drawer-main">
                
                <cly-form-field name="alertName" :label="i18n('alert.Alert_Name')" rules="required">
                    <el-input
                        v-model="drawerScope.editedObject.alertName"
                        class="bu-is-flex" 
                        :placeholder="i18n('alert.enter-alert-name')">
                    </el-input>
                </cly-form-field>

                <cly-form-field name="dataType" :label="i18n('alert.Data_type')" rules="required">
                    <el-radio-group v-on:change="dataTypeSelected" v-model="drawerScope.editedObject.alertDataType" class="bu-is-flex alert-data-type-block">
                        <el-radio-button v-for="(item, idx) in alertDataTypeOptions" :key="idx" :label="item.value" :disabled="drawerScope.editedObject._id && drawerScope.editedObject.alertDataType !== item.value">{{item.label}}</el-radio-button>
                    </el-radio-group>
                </cly-form-field>

                <cly-form-field name="apps" :label="i18n('alert.For_Applications')" rules="required">
                    <cly-app-select 
                            :auth='{"feature": "alerts", "permission":  drawerScope.editedObject._id ? "u": "c"}'
                            class="bu-is-flex"
                            v-model="drawerScope.editedObject.selectedApps"
                            :allowAll="allowAll"
                            >
                    </cly-app-select>
                </cly-form-field> 

                <div class="cly-vue-alert-drawer__line"></div>

                <div class="text-medium text-heading bu-mt-5 bu-has-background-white" style="font-size:13px">
                    {{i18n('alert.Alert_Trigger')}} 
                </div>
                <div v-if="drawerScope.editedObject.alertDataType" class="bu-mb-5 bu-py-4 cly-vue-alert-drawer__card alert-trigger">  
                    <div class="bu-px-4" v-if="showSubType1">
                        <span class="groupcard-text mediumtextNormal-20px" v-if="isCompareTypeSelectAvailable">
                            Send alert if
                        </span>
                        <span class="groupcard-text mediumtextNormal-14px" v-else>
                            Send alert if there is a 
                        </span>
                        <select
                            @change="handleChange($event.target)"
                            class="alert-drawer-trigger-select-and-input" 
                            v-model="drawerScope.editedObject.alertDataSubType">
                            <option :value="null" hidden>metric</option>
                            <option v-for="(metricItem, index) in alertDefine[drawerScope.editedObject.alertDataType].target" :key="index" :value="metricItem.value">
                                {{ metricItem.label }}
                            </option>
                        </select>
                        <span class="groupcard-text mediumtextNormal-14px" v-if="isCompareTypeSelectAvailable">
                            is
                        </span>

                        <select 
                            @change="handleChange($event.target)"
                            v-model="drawerScope.editedObject.compareType" 
                            v-if="isCompareTypeSelectAvailable"
                            class="alert-drawer-trigger-select-and-input">
                            <!--Placeholder for variable selection -->
                            <option :value="null" hidden>variable</option>
                            <!-- Variable selection without online-users data type-->
                            <option
                                v-if="drawerScope.editedObject.alertDataSubType !== 't'"
                                v-for="(variableItem, index) in defaultAlertVariable.condition" 
                                :key="index" 
                                :value="variableItem.value">
                                {{ variableItem.label }}
                            </option>
                            <!-- Variable selection(only for '# of online users' variable) for online-users data type -->
                            <option 
                                v-if="drawerScope.editedObject.alertDataSubType === 't'"
                                v-for="(variableItem, index) in externalAlertDefine[0]['online-users']['condition']"
                                :key="index"
                                :value="variableItem.label">
                                {{ variableItem.label }}
                            </option>
                        </select>

                        <span class="groupcard-text mediumtextNormal-14px" v-if="isCompareTypeSelectAvailable">
                            {{ drawerScope.editedObject.compareType === "more" || drawerScope.editedObject.compareType === "less" ? "than" : "by" }}
                        </span>
                        <input
                            @input="handleChange($event.target)"
                            class="alert-drawer-trigger-select-and-input alert-drawer-trigger-input" 
                            placeholder="value"
                            type="text" 
                            v-model="drawerScope.editedObject.compareValue" 
                            v-if="isCompareTypeSelectAvailable"
                            />
                        <span class="groupcard-text mediumtextNormal-14px" v-if="isCompareTypeSelectAvailable">
                            {{ drawerScope.editedObject.compareType === "more" || drawerScope.editedObject.compareType === "less" ? "" : "%" }}
                        </span>
                        <span class="groupcard-text mediumtextNormal-14px" 
                            v-if="isPeriodSelectAvailable || drawerScope.editedObject.alertDataSubType === 't' ">
                            in the last
                        </span>
                        <select 
                            @change="handleChange($event.target)"
                            v-model="drawerScope.editedObject.period" 
                            v-if="isPeriodSelectAvailable && drawerScope.editedObject.alertDataSubType !== 't'"
                            class="alert-drawer-trigger-select-and-input">
                            <option :value="null" hidden>time</option>
                            <option v-for="(periodItem, index) in alertTimeOptions" :key="index" :value="periodItem.value">
                                {{ periodItem.label }}
                            </option>
                        </select>
                        <input
                            @input="handleChange($event.target)"
                            class="alert-drawer-trigger-select-and-input alert-drawer-trigger-input" 
                            placeholder="value"
                            type="text" 
                            v-model="drawerScope.editedObject.compareValue2"
                            v-if="drawerScope.editedObject.alertDataSubType === 't'"
                            />
                        <span class="groupcard-text mediumtextNormal-14px"
                                v-if="drawerScope.editedObject.alertDataSubType === 't'">
                                minutes
                        </span>
                        <span class="groupcard-text mediumtextNormal-14px">.</span>
                    </div>    
                </div>

                <div class="cly-vue-alert-drawer__line"></div>

                <cly-form-field name="alertValues" :label="i18n('alert.email-to-receive')" rules="required">
                    <cly-select-email v-model="drawerScope.editedObject.alertValues" :collapse-tags="false"></cly-select-email>
                </cly-form-field>
    
                <pre v-if="0">
                    {{drawerScope.editedObject}}
                </pre>
            </cly-form-step>
            </template>
        </cly-drawer>
    </div>
</script>